variables:
  - group: infrastructure

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - src/ltf-poc/identity

pool:
  vmImage: ubuntu-latest

  variables:
    - name: dir
      value: 'src'

steps:
- task: AzureKeyVault@2
  inputs:
    ConnectedServiceName: $(service_name)
    keyVaultName: $(key_vault_name)
    SecretsFilter: '*'
    RunAsPreJob: false

- bash:
    ls -l
  displayName: 'list'
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  
- script: dotnet build --configuration $(buildConfiguration)
  displayName: 'dotnet build $(buildConfiguration)'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: true
- task: AzureWebApp@1
  inputs:
    azureSubscription: $(az-subscription)
    appType: 'webAppLinux'
    appName: 'id-2694-destin-dev'
    package: '$(System.DefaultWorkingDirectory)/**/*.zip'
  env:
    TF_WORKSPACE: Dev
    ARM_SUBSCRIPTION_ID: $(az-subscription)
    ARM_CLIENT_ID:       $(az-client-id)
    ARM_CLIENT_SECRET:   $(az-client-secret)
    ARM_TENANT_ID:       $(az-tenant)

    